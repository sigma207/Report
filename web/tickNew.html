<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr" id="html" ng-app="myApp">
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">

    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">-->
    <script src="js/angular.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="http://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
    <script src="js/utility.js"></script>
    <script src="js/moment.min.js"></script>
    <script src="js/numeral.min.js"></script>
    <script src="js/dataLoad.js"></script>
    <script src="js/reportTable.js"></script>
    <!--<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>-->
    <script type="text/javascript">
        var symbolArr;
        var qtype = "1019";
        var defaultSymbol = "TFCC";
        var reportTable1;
        var reportTable2;
        var reportDataManager;
        var dataLoad;
        $(document).ready(function () {
            var datePicker = $("#datepicker");
            datePicker.datepicker();
            datePicker.datepicker("option", "dateFormat", "yymmdd");
            datePicker.val(today());
            init();

            $("#symbolId").on("change", function () {
                onSymbolIdChange();
            });

            $("#qrybtn").click(function () {
                onQueryBtnClick();
            });
        });

        function onSymbolIdChange() {
            var symbolId = $("#symbolId").val();
            var symbolInfo = symbolArr[symbolId];
            $("#datepicker").val(symbolInfo[14]);
            $("#stime").val(hhmmssTohh_mm_ss(symbolInfo[4]));
            $("#etime").val(hhmmssTohh_mm_ss(symbolInfo[7]));
            var stimeArr = hhmmssTohh_mm_ss(symbolInfo[4]).split(":");
            setTimeSelect("stimehh", 24, stimeArr[0]);
            setTimeSelect("stimemm", 60, stimeArr[1]);
            setTimeSelect("stimess", 60, stimeArr[2]);
            stimeArr = hhmmssTohh_mm_ss(symbolInfo[7]).split(":");
            setTimeSelect("etimehh", 24, stimeArr[0]);
            setTimeSelect("etimemm", 60, stimeArr[1]);
            setTimeSelect("etimess", 60, stimeArr[2]);
//            onQueryBtnClick();
        }

        function setTimeSelect(divName, max, value) {
            var timeSelect = $("#" + divName);
            timeSelect.empty();
            var temp = "";
            for (var i = 0; i < max; i++) {
                temp += SelectTool.getTimeOptionHtml(i, i, (value == i));
            }
            timeSelect.append(temp);
        }

        function onQueryBtnClick() {
            var symbolId = $("#symbolId").val();
            symbolId = symbolArr[symbolId][0];

            var dateStr = $("#datepicker").val();
            var eDateStr = dateStr;
            var stime = $("#stimehh").val() + ":" + $("#stimemm").val() + ":" + $("#stimess").val();//$("#stime").val();
            var etime = $("#etimehh").val() + ":" + $("#etimemm").val() + ":" + $("#etimess").val();//$("#etime").val();
            if (etime < stime) {
                var newDate = new Date(dateStr.substring(0, 4) + "-" + dateStr.substring(4, 6) + "-" + dateStr.substring(6));
                newDate = new Date(newDate.setDate(newDate.getDate() + 1));
                eDateStr = toYYYYMMDD(newDate);
            }

            var execUrl = baseUrl + "1019?symbolId=" + symbolId + "&beginDate=" + dateStr + "&beginTime=" + stime + "&endDate=" + eDateStr + "&endTime=" + etime;
            $("#timeStr").text(dateStr + " " + stime + " ---> " + eDateStr + " " + etime);

            if (qtype == "1018") {
                var price = $("#price").val();
                execUrl = baseUrl + "1018?symbolId=" + symbolId + "&date=" + dateStr + "&price=" + price;
            }
            dataLoad.getReportJSON(execUrl, onReportDataComplete);
        }

        function init() {
            if (getUrlParameter("symbol_id")) {
                defaultSymbol = getUrlParameter("symbol_id");
            }
            if (getUrlParameter("css")) {
                css = getUrlParameter("css");
            }
            DomTool.appendCss("css/" + css + ".css");

            dataLoad = DataLoad.createNew();
            var execUrl = baseUrl + "2025";
            dataLoad.getCommonJSON(execUrl, onSymbolDataComplete);
            reportTable1 = ReportTable.createNew("reportTable1");
            reportTable2 = ReportTable.createNew("reportTable2");
            reportDataManager = ReportDataManager.createNew(true);
            reportDataManager.addTable(reportTable1);
            reportDataManager.addTable(reportTable2);
        }

        function onReportDataComplete() {
            var columnTypes = ["text", "number", "number", "number"];
            reportTable1.setReportColumns(dataLoad.loadCh, columnTypes);
            reportTable2.setReportColumns(dataLoad.loadCh, columnTypes);
            reportDataManager.setDataSource(dataLoad.loadC);
        }

        function onSymbolDataComplete() {
            symbolArr = dataLoad.loadC;
            var count = symbolArr.length;
            var temp = "";
            for (var i = 0; i < count; i++) {
                temp += SelectTool.getOptionHtml(i, symbolArr[i][17], (symbolArr[i][0] == defaultSymbol));
            }
            $("#symbolId").append(temp);
            onSymbolIdChange();
        }

        function MyController($scope){
            $scope.queryType = [{value:"1019",label:"時間"},{value:"1018",label:"價格"}];
            $scope.selectQueryType = $scope.queryType[0];
        }

    </script>
</head>
<body ng-controller="MyController">
<table>
    <tr style="background:#ffffff">
        <td style='font-color:#000000'>
            商品：
        </td>
        <td>
            <select id="symbolId" class="form-control">
            </select>
        </td>
        <td>
            日期：
        </td>
        <td>
            <input type="text" id="datepicker" class="form-control">
        </td>
        <td>
            條件：
        </td>
        <td>
            <select id="qtype" class="form-control" ng-model="selectQueryType" ng-options="type.label for type in queryType">
            </select>
        </td>
        <td>
            <button id="qrybtn" class="btn btn-default">送出</button>
        </td>
    </tr>
    <tr style="background:#ffffff">
        <td colspan="2">
        </td>
        <td colspan="5" style="text-align: left;">
            <div id="1019view" ng-show="selectQueryType.value=='1019'">
                開始：<input type="text" id="stime" class="form-control" value="" hidden>
                <select id="stimehh" style='width:45px;padding-right:0px;padding-left:3px;'>
                </select>時
                <select id="stimemm" style='width:45px;padding-right:0px;padding-left:3px;'>
                </select>分
                <select id="stimess" style='width:45px;padding-right:0px;padding-left:3px;'>
                </select>秒
                結束：<input type="text" id="etime" class="form-control" value="" hidden>
                <select id="etimehh" style='width:45px;padding-right:0px;padding-left:3px;'>
                </select>時
                <select id="etimemm" style='width:45px;padding-right:0px;padding-left:3px;'>
                </select>分
                <select id="etimess" style='width:45px;padding-right:0px;padding-left:3px;'>
                </select>秒
            </div>
            <div id="1018view" ng-show="selectQueryType.value=='1018'">
                價格<input type="text" id="price" class="form-control" value="">
            </div>
        </td>
    </tr>
    <tr style="background:#ffffff">
        <td colspan="7" style='text-align: left;'>
            時間：<label id="timeStr"></label>
        </td>
</table>
<div class="reportTableContainer" style="width: 100%;">
    <div style="float: left;width: 49%;">
        <table width="100%" class="reporttable reportTable1">
            <thead>
            <tr>
                <th field="column0">市場時間</th>
                <th field="column1" type="number">口數</th>
                <th field="column2" type="number">價格</th>
                <th field="column3" type="number">次序</th>
            </tr>
            </thead>
        </table>
    </div>
    <div style="float: right;width: 49%;">
        <table width="100%" class="reporttable reportTable2">
            <thead>
            <tr>
                <th field="column0">市場時間</th>
                <th field="column1" type="number">口數</th>
                <th field="column2" type="number">價格</th>
                <th field="column3" type="number">次序</th>
            </tr>
            </thead>
        </table>
    </div>
</div>
<script type="text/javascript">
    angular.module("myApp",[]).controller("MyController",MyController);
</script>
</body>
</html>	